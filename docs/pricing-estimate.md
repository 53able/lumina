# Lumina システム料金試算

> **為替レート**: 1ドル = 157円（2025年1月時点）

## OpenAI API 料金（2025年1月時点）

### モデル別料金

| モデル | 入力 | 出力 | 備考 |
|--------|------|------|------|
| **gpt-4.1-nano** | $0.100 / 1M tokens | $0.400 / 1M tokens | コンテキストウィンドウ: 1.0M tokens |
| **text-embedding-3-small** | $0.02 / 1M tokens | - | 出力は固定次元（1536次元） |

### 料金換算（円）

- gpt-4.1-nano 入力: **$0.100 / 1M tokens = 15.7円 / 1M tokens**
- gpt-4.1-nano 出力: **$0.400 / 1M tokens = 62.8円 / 1M tokens**
- text-embedding-3-small: **$0.02 / 1M tokens = 3.14円 / 1M tokens**

---

## 機能別料金試算

### 1. 検索API (`/api/v1/search`)

**処理内容**:
1. クエリ拡張（gpt-4.1-nano）
2. Embedding生成（text-embedding-3-small）

#### 1-1. クエリ拡張

**使用モデル**: `gpt-4.1-nano`

**トークン数推定**:
- システムプロンプト: 約1,200 tokens
- Few-shot例: 約300 tokens
- ユーザークエリ: 10-30 tokens（平均20 tokens）
- **入力合計**: 約1,520 tokens

- 出力（JSON）: 50-100 tokens（平均75 tokens）

**料金計算**:
- 入力: 1,520 tokens × $0.100 / 1M = **$0.000152**
- 出力: 75 tokens × $0.400 / 1M = **$0.00003**
- **小計**: **$0.000182 ≈ 0.029円**

#### 1-2. Embedding生成

**使用モデル**: `text-embedding-3-small`

**トークン数推定**:
- 拡張クエリ（searchText）: 20-50 tokens（平均35 tokens）

**料金計算**:
- 入力: 35 tokens × $0.02 / 1M = **$0.0000007 ≈ 0.0001円**

#### 検索API 合計

| 項目 | 料金（ドル） | 料金（円） |
|------|------------|-----------|
| クエリ拡張 | $0.000182 | 0.029円 |
| Embedding生成 | $0.0000007 | 0.0001円 |
| **合計** | **$0.0001827** | **約0.03円** |

---

### 2. Embedding API (`/api/v1/embedding`)

**処理内容**: テキストからEmbedding生成

**使用モデル**: `text-embedding-3-small`

**トークン数推定**:
- ユーザー入力テキスト: 10-500 tokens（平均100 tokens）

**料金計算**:
- 入力: 100 tokens × $0.02 / 1M = **$0.000002 ≈ 0.0003円**

| 項目 | 料金（ドル） | 料金（円） |
|------|------------|-----------|
| Embedding生成 | $0.000002 | 0.0003円 |
| **合計** | **$0.000002** | **約0.0003円** |

---

### 3. 要約API (`/api/v1/summary/:id`)

**処理内容**:
1. 要約生成（gpt-4.1-nano）- `generateTarget: "both"` の場合
2. 説明文生成（gpt-4.1-nano）- `generateTarget: "explanation"` または `"both"` の場合

#### 3-1. 要約生成

**使用モデル**: `gpt-4.1-nano`

**トークン数推定**:
- システムプロンプト: 約1,500 tokens
- Few-shot例: 約200 tokens
- アブストラクト: 150-300 words ≈ 200-400 tokens（平均300 tokens）
- **入力合計**: 約2,000 tokens

- 出力（JSON）: 100-200 tokens（平均150 tokens）

**料金計算**:
- 入力: 2,000 tokens × $0.100 / 1M = **$0.0002**
- 出力: 150 tokens × $0.400 / 1M = **$0.00006**
- **小計**: **$0.00026 ≈ 0.041円**

#### 3-2. 説明文生成

**使用モデル**: `gpt-4.1-nano`

**トークン数推定**:
- システムプロンプト: 約1,800 tokens
- Few-shot例: 約250 tokens
- アブストラクト: 平均300 tokens
- **入力合計**: 約2,350 tokens

- 出力（JSON）: 80-150 tokens（平均115 tokens）

**料金計算**:
- 入力: 2,350 tokens × $0.100 / 1M = **$0.000235**
- 出力: 115 tokens × $0.400 / 1M = **$0.000046**
- **小計**: **$0.000281 ≈ 0.044円**

#### 要約API 合計

| 生成対象 | 料金（ドル） | 料金（円） |
|---------|------------|-----------|
| 要約のみ (`explanation`) | $0.000281 | 0.044円 |
| 要約 + 説明文 (`both`) | $0.000541 | 0.085円 |

---

### 4. 同期API (`/api/v1/sync`)

**処理内容**:
1. arXivから論文取得（無料）
2. 各論文にEmbedding生成（text-embedding-3-small）

**使用モデル**: `text-embedding-3-small`

**トークン数推定（1論文あたり）**:
- タイトル: 10-20 words ≈ 15 tokens
- アブストラクト: 150-300 words ≈ 200-400 tokens（平均300 tokens）
- **合計**: 約315 tokens

**料金計算（1論文あたり）**:
- 入力: 315 tokens × $0.02 / 1M = **$0.0000063 ≈ 0.001円**

**デフォルト設定（maxResults: 50）の場合**:
- 50論文 × $0.0000063 = **$0.000315 ≈ 0.05円**

| 項目 | 料金（ドル） | 料金（円） |
|------|------------|-----------|
| 1論文あたり | $0.0000063 | 0.001円 |
| 50論文（デフォルト） | $0.000315 | 0.05円 |

---

## 料金試算サマリー

| 機能 | 1回あたりの料金（円） | 備考 |
|------|---------------------|------|
| **検索API** | **約0.03円** | クエリ拡張 + Embedding生成 |
| **Embedding API** | **約0.0003円** | テキスト長に依存（100 tokens想定） |
| **要約API（要約のみ）** | **約0.044円** | `generateTarget: "explanation"` |
| **要約API（要約+説明文）** | **約0.085円** | `generateTarget: "both"`（デフォルト） |
| **同期API（1論文）** | **約0.001円** | タイトル+アブストラクトのEmbedding |
| **同期API（50論文）** | **約0.05円** | デフォルト設定（maxResults: 50） |

---

## 使用量シナリオ別の月額料金試算

### シナリオ1: 個人利用（軽度）

- 検索: 100回/月
- 要約: 50回/月（both）
- 同期: 10回/月（50論文/回）

**計算**:
- 検索: 100 × 0.03円 = 3円
- 要約: 50 × 0.085円 = 4.25円
- 同期: 10 × 0.05円 = 0.5円
- **合計: 約7.75円/月**

### シナリオ2: 個人利用（中程度）

- 検索: 500回/月
- 要約: 200回/月（both）
- 同期: 20回/月（50論文/回）

**計算**:
- 検索: 500 × 0.03円 = 15円
- 要約: 200 × 0.085円 = 17円
- 同期: 20 × 0.05円 = 1円
- **合計: 約33円/月**

### シナリオ3: チーム利用（活発）

- 検索: 2,000回/月
- 要約: 1,000回/月（both）
- 同期: 50回/月（50論文/回）

**計算**:
- 検索: 2,000 × 0.03円 = 60円
- 要約: 1,000 × 0.085円 = 85円
- 同期: 50 × 0.05円 = 2.5円
- **合計: 約147.5円/月**

---

## 注意事項

1. **トークン数は変動する**
   - クエリの長さ、アブストラクトの長さにより変動
   - 上記は平均的な想定値

2. **gpt-4.1-nanoの出力トークン数**
   - 要約・説明文の品質により変動
   - より詳細な出力を要求する場合は増加

3. **同期APIの料金**
   - `maxResults`パラメータに比例
   - 50論文 = 0.05円、100論文 = 0.1円

4. **キャッシュの効果**
   - gpt-4.1-nanoはキャッシュ入力に対応（$0.025 / 1M tokens）
   - 同じシステムプロンプトを繰り返し使用する場合、約75%のコスト削減が可能

---

## コスト最適化のヒント

1. **要約APIの使い分け**
   - 既存の要約がある場合は `generateTarget: "explanation"` のみで約50%削減

2. **同期APIのバッチサイズ**
   - 一度に大量の論文を同期するより、定期的に少量ずつ同期する方が効率的

3. **検索クエリの最適化**
   - 短く具体的なクエリの方がトークン数を抑えられる

4. **キャッシュの活用**
   - システムプロンプトのキャッシュを有効化（OpenAI APIの機能）
